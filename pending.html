<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanrico Mercantile - Pending Orders</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/tooltip.css">
    <link rel="stylesheet" href="css/pending.css">
    <script src="js/stockManager.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/toast.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="pending-header">
        <div class="container header-container">
            <div class="logo-container">
                <img src="images/sanrico_logo_1.png" alt="Sanrico Mercantile Logo" class="logo-img">
                <div class="logo">
                    Sanrico <span>Mercantile</span> - Staff Dashboard
                </div>
            </div>
            <div class="header-controls">
                <div class="staff-info">
                    <span id="staffName">Staff Member</span>
                    <button class="action-btn secondary" id="backToDashboardBtn">‚Üê Back to Dashboard</button>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pending-main">
        <div class="container pending-container">
            <!-- Orders Header -->
            <section class="orders-header">
                <div class="orders-title">
                    <h2>Orders Management</h2>
                    <div class="orders-count">
                        <span id="totalOrders">0</span> pending orders
                    </div>
                </div>
                <div class="orders-actions">
                    <div class="filter-controls">
                        <div class="status-filter">
                            <label for="statusFilter">Filter by Status:</label>
                            <select id="statusFilter" class="form-control status-select">
                                <option value="all">All Orders</option>
                                <option value="pending">Pending</option>
                                    <option value="accepted">Accepted</option>
                            </select>
                        </div>
                        <div class="date-filter">
                            <label for="dateFilter">Filter by Date:</label>
                            <input type="date" id="dateFilter" class="form-control date-input">
                        </div>
                        <button class="action-btn refresh" id="refreshBtn">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
            </section>

            <!-- Status Overview -->
            <section class="status-overview" id="statusOverview">
                <div class="status-stat pending-stat">
                    <span class="stat-number" id="pendingCount">0</span>
                    <span class="stat-label">‚è≥ Pending</span>
                </div>
                <div class="status-stat accepted-stat">
                    <span class="stat-number" id="acceptedCount">0</span>
                    <span class="stat-label">‚úÖ Accepted</span>
                </div>
            </section>

            <!-- Orders Grid -->
            <section class="orders-management">
                <div class="orders-grid" id="ordersGrid">
                    <!-- Orders will be loaded here -->
                </div>
                
                <!-- Pagination -->
                <div class="pagination" id="pagination"></div>
            </section>
        </div>
    </main>

    <!-- Order Details Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content order-modal-content">
            <button class="modal-close" id="orderModalClose">√ó</button>
            <h2 class="modal-title">Order Details</h2>
            
            <div class="order-details-form">
                <div class="order-info-section">
                    <div class="order-header-info">
                        <div class="order-id">
                            <label>Order ID:</label>
                            <span id="modalOrderId">#12345</span>
                        </div>
                        <div class="order-date">
                            <label>Order Date:</label>
                            <span id="modalOrderDate">2024-01-15</span>
                        </div>
                    </div>
                    
                    <div class="customer-info">
                        <h3>Customer Information</h3>
                        <div class="customer-details">
                            <div class="customer-field">
                                <label>Name:</label>
                                <span id="modalCustomerName">John Doe</span>
                            </div>
                            <div class="customer-field">
                                <label>Email:</label>
                                <span id="modalCustomerEmail">john@example.com</span>
                            </div>
                            <div class="customer-field">
                                <label>Phone:</label>
                                <span id="modalCustomerPhone">+63 912 345 6789</span>
                            </div>
                            <div class="customer-field">
                                <label>Address:</label>
                                <span id="modalCustomerAddress">N/A</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="order-items-section">
                    <h3>Order Items</h3>
                    <div class="items-list" id="modalOrderItems">
                        <!-- Items will be populated here -->
                    </div>
                    
                    <div class="order-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="modalSubtotal">‚Ç±0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span id="modalTotal">‚Ç±0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="status-update-section">
                    <h3>Update Order Status</h3>
                    <div class="status-controls">
                        <select id="newOrderStatus" class="form-control">
                            <option value="pending">Pending</option>
                            <option value="accepted">Accepted</option>
                        </select>
                        <textarea id="statusNotes" class="form-control" placeholder="Add notes (optional)..." rows="3"></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="action-btn cancel" id="cancelOrderEdit">Cancel</button>
                <button class="action-btn primary" id="updateOrderStatus">Update Status</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast" id="toast"></div>

    <script>

        // Check if user is logged in as staff
        function checkStaffAuth() {
            console.log('üîç Checking staff authentication...');
            const currentUser = Auth.getCurrentUser();
            console.log('Current user:', currentUser);
            
            if (!currentUser) {
                console.log('‚ùå No current user found - allowing for testing');
                document.getElementById('staffName').textContent = 'Test Staff';
                return true; // Temporarily allow for testing
            }
            
            if (!currentUser.isStaff) {
                console.log('‚ùå User is not staff - allowing for testing:', currentUser);
                document.getElementById('staffName').textContent = currentUser.fullName || currentUser.username || 'Test Staff';
                return true; // Temporarily allow for testing
            }
            
            console.log('‚úÖ Staff authentication successful');
            document.getElementById('staffName').textContent = currentUser.fullName || currentUser.staffId;
            return true;
        }

        // Initialize staff system
        try {
            console.log('üöÄ Starting pending orders system...');
            if (!checkStaffAuth()) {
                throw new Error('Unauthorized access');
            }
            
            console.log('‚úÖ Authentication passed, initializing PendingOrdersManager...');
        } catch (error) {
            console.error('‚ùå Failed to initialize:', error);
        }

        // Pending Orders Management Class
        class PendingOrdersManager {
            constructor() {
                console.log('üèóÔ∏è PendingOrdersManager constructor called');
                this.orders = [];
                this.currentPage = 1;
                this.itemsPerPage = 8;
                this.currentStatus = 'all';
                this.currentDate = '';
                
                console.log('üéØ Initializing event listeners...');
                this.initializeEventListeners();
                console.log('üìã Starting to load orders...');
                this.loadOrders().then(orders => {
                    console.log('üì• Orders loaded:', orders.length, 'orders');
                    this.orders = orders;
                    console.log('üé® Rendering orders...');
                this.renderOrders();
                    console.log('üìä Updating order count...');
                this.updateOrderCount();
                    console.log('‚úÖ PendingOrdersManager fully initialized!');
                }).catch(error => {
                    console.error('‚ùå Error in loadOrders promise:', error);
                });
            }

            async loadOrders() {
                try {
                    console.log('üîç loadOrders() called - fetching pending orders...');
                    // Fetch orders from database API
                    const response = await fetch('http://localhost:3000/api/orders/pending');
                    console.log('üì° API response status:', response.status, response.statusText);
                    if (response.ok) {
                        const dbOrders = await response.json();
                        console.log('üíæ Raw database orders:', dbOrders.length, 'orders received');
                        
                        // Transform database orders to the format expected by the frontend
                        return dbOrders.map(order => ({
                            id: order._id,
                            date: order.date_ordered,
                            customer: {
                                name: order.buyerinfo,
                                email: '',
                                phone: order.shipping?.phoneNumber || ''
                            },
                            items: order.itemsordered.map(item => ({
                                name: item.item_name,
                                quantity: item.amount_per_item,
                                price: item.price_per_item
                            })),
                            status: order.status.toLowerCase(),
                            total: order.total,
                            notes: order.notes || '',
                            address: order.address
                        }));
                    } else {
                        console.warn('Failed to fetch orders from database, using empty array');
                        return [];
                    }
                } catch (error) {
                    console.error('Error loading orders from database:', error);
                    showToast('Failed to load orders from database', 'error');
                    return [];
                }
            }

            initializeEventListeners() {
                // Filter controls
                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    this.filterByStatus(e.target.value);
                });

                document.getElementById('dateFilter').addEventListener('change', (e) => {
                    this.filterByDate(e.target.value);
                });

                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.refreshOrders();
                });

                // Modal events
                document.getElementById('orderModalClose').addEventListener('click', () => {
                    this.closeModal();
                });

                document.getElementById('cancelOrderEdit').addEventListener('click', () => {
                    this.closeModal();
                });

                document.getElementById('updateOrderStatus').addEventListener('click', () => {
                    this.updateOrderStatus();
                });

                // Header buttons
                document.getElementById('backToDashboardBtn').addEventListener('click', () => {
                    window.location.href = 'staff-dashboard.html';
                });

                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.handleLogout();
                });

                // Event delegation for order action buttons
                const self = this;
                document.addEventListener('click', function(e) {
                    if (e.target.closest('[data-action]')) {
                        const button = e.target.closest('[data-action]');
                        const action = button.getAttribute('data-action');
                        const orderId = button.getAttribute('data-order-id');
                        
                        console.log('üñ±Ô∏è Button clicked:', action, 'for order:', orderId);
                        
                        if (action === 'view') {
                            console.log('üìã Calling viewOrder with:', orderId);
                            self.viewOrder(orderId);
                        } else if (action === 'update') {
                            console.log('üîÑ Calling quickStatusUpdate with:', orderId);
                            self.quickStatusUpdate(orderId);
                        }
                    }
                });
            }

            getStatusClass(status) {
                switch(status) {
                    case 'pending': return 'status-pending';
                    case 'accepted': return 'status-accepted';
                    default: return 'status-pending';
                }
            }

            getStatusText(status) {
                switch(status) {
                    case 'pending': return 'Pending';
                    case 'accepted': return 'Accepted';
                    default: return 'Pending';
                }
            }

            filterByStatus(status) {
                this.currentStatus = status;
                this.currentPage = 1;
                this.renderOrders();
            }

            filterByDate(date) {
                this.currentDate = date;
                this.currentPage = 1;
                this.renderOrders();
            }

            async refreshOrders() {
                // Fetch fresh data from server
                this.orders = await this.loadOrders();
                this.renderOrders();
                showToast('Orders refreshed successfully');
            }

            getStatusIcon(status) {
                switch(status) {
                    case 'pending': return '‚è≥';
                    case 'accepted': return '‚úÖ';
                    default: return '‚è≥';
                }
            }

            getStatusButtonClass(status) {
                switch(status) {
                    case 'pending': return 'approve-btn';
                    case 'accepted': return 'approved-btn';
                    default: return 'approve-btn';
                }
            }

            getNextStatusText(status) {
                switch(status) {
                    case 'pending': return '‚úÖ Approve Order';
                    case 'accepted': return '‚úì Approved';
                    default: return 'Approve Order';
                }
            }

            renderOrders() {
                const grid = document.getElementById('ordersGrid');
                
                // Filter orders
                let filteredOrders = this.orders;
                
                // Apply status filter
                if (this.currentStatus && this.currentStatus !== 'all') {
                    filteredOrders = filteredOrders.filter(order => order.status === this.currentStatus);
                }
                
                // Apply date filter
                if (this.currentDate) {
                    filteredOrders = filteredOrders.filter(order => order.date === this.currentDate);
                }
                
                const start = (this.currentPage - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                const displayed = filteredOrders.slice(start, end);

                if (displayed.length === 0) {
                    grid.innerHTML = '<div class="no-orders">No orders found</div>';
                    return;
                }

                grid.innerHTML = displayed.map(order => `
                    <div class="order-card" data-order-id="${order.id}">
                        <div class="order-header">
                            <div class="order-id">
                                <strong>${order.id}</strong>
                            </div>
                        </div>
                        
                        <div class="order-info">
                            <div class="customer-name">
                                <strong>${order.customer.name}</strong>
                            </div>
                            <div class="order-date">
                                üìÖ ${new Date(order.date).toLocaleDateString()}
                            </div>
                            <div class="order-total">
                                üí∞ ‚Ç±${order.total.toFixed(2)}
                            </div>
                            <div class="items-count">
                                üì¶ ${order.items.length} item${order.items.length !== 1 ? 's' : ''}
                            </div>
                        </div>
                        
                        <div class="status-timeline">
                            <div class="timeline-step ${order.status === 'pending' || order.status === 'accepted' ? 'active' : ''}">
                                <span class="step-icon">‚è≥</span>
                                <span class="step-label">Pending</span>
                            </div>
                            <div class="timeline-step ${order.status === 'accepted' ? 'active' : ''}">
                                <span class="step-icon">‚úÖ</span>
                                <span class="step-label">Accepted</span>
                            </div>
                        </div>
                        
                        <div class="order-total-amount">
                            <strong>Total: ‚Ç±${order.total.toFixed(2)}</strong>
                        </div>
                        
                        <div class="order-actions">
                            <button class="action-btn primary view-btn" onclick="window.pendingManager.viewOrder('${order.id}')">
                                üëÅÔ∏è View Details
                            </button>
                            <button class="action-btn status-update-btn ${this.getStatusButtonClass(order.status)}" onclick="window.pendingManager.quickStatusUpdate('${order.id}')">
                                ${this.getNextStatusText(order.status)}
                            </button>
                        </div>
                    </div>
                `).join('');

                this.updatePagination(filteredOrders.length);
                
                this.updateStatusOverview();
            }

            updateStatusOverview() {
                const statusCounts = {
                    pending: 0,
                    accepted: 0
                };
                
                this.orders.forEach(order => {
                    if (statusCounts.hasOwnProperty(order.status)) {
                        statusCounts[order.status]++;
                    }
                });
                
                document.getElementById('pendingCount').textContent = statusCounts.pending;
                document.getElementById('acceptedCount').textContent = statusCounts.accepted;
            }

            updatePagination(totalItems) {
                const totalPages = Math.ceil(totalItems / this.itemsPerPage);
                const pagination = document.getElementById('pagination');
                
                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                pagination.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.className = `page-btn ${i === this.currentPage ? 'active' : ''}`;
                    button.onclick = () => {
                        this.currentPage = i;
                        this.renderOrders();
                    };
                    pagination.appendChild(button);
                }
            }

            updateOrderCount() {
                document.getElementById('totalOrders').textContent = this.orders.length;
            }

            viewOrder(orderId) {
                console.log('üëÅÔ∏è ViewOrder called with ID:', orderId);
                
                const order = this.orders.find(o => o.id === orderId);
                if (!order) {
                    console.error('‚ùå Order not found:', orderId);
                    showToast('Order not found', 'error');
                    return;
                }
                
                console.log('‚úÖ Order found:', order);
                this.currentEditingOrder = order;
                
                try {
                    // Populate modal with safe checks
                    const modalOrderId = document.getElementById('modalOrderId');
                    const modalOrderDate = document.getElementById('modalOrderDate');
                    const modalCustomerName = document.getElementById('modalCustomerName');
                    const modalCustomerEmail = document.getElementById('modalCustomerEmail');
                    const modalCustomerPhone = document.getElementById('modalCustomerPhone');
                    
                    if (modalOrderId) modalOrderId.textContent = order.id || 'N/A';
                    if (modalOrderDate) modalOrderDate.textContent = order.date ? new Date(order.date).toLocaleDateString() : 'N/A';
                    if (modalCustomerName) modalCustomerName.textContent = order.customer?.name || 'N/A';
                    if (modalCustomerEmail) modalCustomerEmail.textContent = order.customer?.email || 'N/A';
                    if (modalCustomerPhone) modalCustomerPhone.textContent = order.customer?.phone || 'N/A';
                    
                    // Add address if element exists
                    const modalCustomerAddress = document.getElementById('modalCustomerAddress');
                    if (modalCustomerAddress) modalCustomerAddress.textContent = order.address || 'N/A';
                    
                    // Populate items
                    const itemsList = document.getElementById('modalOrderItems');
                    if (itemsList && order.items) {
                        itemsList.innerHTML = order.items.map(item => `
                            <div class="order-item">
                                <div class="item-info">
                                    <span class="item-name">${item.name || 'Unknown Item'}</span>
                                    <span class="item-details">Qty: ${item.quantity || 0} √ó ‚Ç±${(item.price || 0).toFixed(2)}</span>
                                </div>
                                <div class="item-total">‚Ç±${((item.quantity || 0) * (item.price || 0)).toFixed(2)}</div>
                            </div>
                        `).join('');
                    }
                    
                    // Update totals
                    const subtotal = order.items ? order.items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.price || 0)), 0) : 0;
                    const modalSubtotal = document.getElementById('modalSubtotal');
                    const modalTotal = document.getElementById('modalTotal');
                    
                    if (modalSubtotal) modalSubtotal.textContent = `‚Ç±${subtotal.toFixed(2)}`;
                    if (modalTotal) modalTotal.textContent = `‚Ç±${(order.total || 0).toFixed(2)}`;
                    
                    // Set current status
                    const newOrderStatus = document.getElementById('newOrderStatus');
                    const statusNotes = document.getElementById('statusNotes');
                    
                    if (newOrderStatus) newOrderStatus.value = order.status || 'pending';
                    if (statusNotes) statusNotes.value = order.notes || '';
                    
                    // Show modal
                    const modal = document.getElementById('orderModal');
                    if (modal) {
                        modal.classList.add('show');
                        console.log('‚úÖ Modal shown successfully');
                    } else {
                        console.error('‚ùå Modal element not found');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error in viewOrder:', error);
                    showToast('Error displaying order details', 'error');
                }
            }

            async quickStatusUpdate(orderId) {
                const order = this.orders.find(o => o.id === orderId);
                if (!order) return;
                
                // For the simplified 2-state system: pending -> accepted
                if (order.status === 'pending') {
                    try {
                        // Update status in database
                        const response = await fetch(`http://localhost:3000/api/orders/${orderId}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: 'Accepted' })
                        });
                        
                        if (response.ok) {
                            order.status = 'accepted';
                this.renderOrders();
                            showToast(`Order ${orderId} has been approved!`);
                        } else {
                            showToast('Failed to update order status', 'error');
                        }
                    } catch (error) {
                        console.error('Error updating order status:', error);
                        showToast('Error updating order status', 'error');
                    }
                } else {
                    showToast('Order is already approved', 'info');
                }
            }

            updateOrderStatus() {
                if (!this.currentEditingOrder) return;
                
                const newStatus = document.getElementById('newOrderStatus').value;
                const notes = document.getElementById('statusNotes').value;
                
                this.currentEditingOrder.status = newStatus;
                this.currentEditingOrder.notes = notes;
                
                this.saveOrders();
                this.renderOrders();
                this.closeModal();
                showToast(`Order ${this.currentEditingOrder.id} updated successfully`);
            }

            closeModal() {
                document.getElementById('orderModal').classList.remove('show');
                this.currentEditingOrder = null;
            }

            saveOrders() {
                localStorage.setItem('pending_orders', JSON.stringify(this.orders));
            }

            handleLogout() {
                const currentUser = Auth.getCurrentUser();
                const staffId = currentUser ? currentUser.staffId : '';
                const result = Auth.logout();
                if (result.success) {
                    showToast(`${staffId} successfully logged out`);
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } else {
                    showToast(result.message);
                }
            }
        }

        // Global test function for debugging
        window.testViewOrder = function(orderId) {
            console.log('üß™ Test function called with order ID:', orderId);
            if (window.pendingManager) {
                window.pendingManager.viewOrder(orderId);
            } else {
                console.error('‚ùå pendingManager not found');
            }
        };

        // Initialize Pending Orders Manager
        console.log('üöÄ About to create PendingOrdersManager instance...');
        let pendingManager = null;
        try {
            pendingManager = new PendingOrdersManager();
            console.log('‚úÖ PendingOrdersManager successfully created:', pendingManager);
            
            // Make it globally accessible for onclick handlers
            window.pendingManager = pendingManager;
        } catch (error) {
            console.error('‚ùå Failed to create PendingOrdersManager:', error);
        }
    </script>
</body>
</html>
